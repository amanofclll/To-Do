<script>
  const userId = 'unique_user_id';  // Unique ID for each user. You can generate this dynamically.
  let tasks = JSON.parse(localStorage.getItem(userId + '_tasks')) || [];

  // Add task with or without file
  function addTask(pastedFile = null) {
    const taskInput = document.getElementById('taskInput').value || 'No description provided';
    const statusInput = document.getElementById('statusInput').value;
    const fileInput = document.getElementById('fileInput').files[0];

    let newTask = {
      id: Date.now(),
      description: taskInput,
      status: statusInput,
      fileType: null,
      fileName: null,
      file: null
    };

    const file = pastedFile || fileInput;

    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const fileType = file.type.startsWith('image/') ? 'image' : file.type.startsWith('video/') ? 'video' : 'file';
        newTask = {
          ...newTask,
          fileType: fileType,
          fileName: file.name,
          file: e.target.result
        };
        tasks.push(newTask);
        updateLocalStorage();
        renderTasks(tasks);
      };
      reader.readAsDataURL(file);
    } else {
      tasks.push(newTask);
      updateLocalStorage();
      renderTasks(tasks);
    }

    // Clear the inputs
    document.getElementById('taskInput').value = '';
    document.getElementById('fileInput').value = '';
    document.getElementById('statusInput').value = 'Pending';
  }

  // Allow users to paste files (Ctrl + V)
  document.addEventListener('paste', (event) => {
    const clipboardData = event.clipboardData || window.clipboardData;
    const items = clipboardData.items;
    if (items.length > 0) {
      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        if (item.kind === 'file') {
          const file = item.getAsFile();
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const fileType = file.type.startsWith('image/') ? 'image' : file.type.startsWith('video/') ? 'video' : 'file';
              openModal(e.target.result, 'Pasted File Preview', fileType);

              // Option to add pasted file as a task
              document.getElementById('addTaskButton').onclick = () => addTask(file);
            };
            reader.readAsDataURL(file);
          }
        }
      }
    }
  });

  // Share tasks via a generated code
  function shareTasks() {
    const shareCode = Math.random().toString(36).substr(2, 9);  // Generate a random code
    localStorage.setItem(shareCode + '_tasks', JSON.stringify(tasks));
    document.getElementById('shareCode').innerText = `Share Code: ${shareCode}`;
  }

  // Load tasks using share code
  function loadSharedTasks() {
    const shareCode = document.getElementById('shareCodeInput').value;
    const sharedTasks = JSON.parse(localStorage.getItem(shareCode + '_tasks'));
    if (sharedTasks) {
      tasks = sharedTasks;
      updateLocalStorage();
      renderTasks(tasks);
    } else {
      alert('Invalid Share Code');
    }
  }

  // Render tasks
  function renderTasks(taskList) {
    const taskListElement = document.getElementById('taskList');
    taskListElement.innerHTML = '';

    taskList.forEach(task => {
      const taskItem = document.createElement('li');
      taskItem.classList.add('task-item');
      let fileDisplay;

      // Check the file type to determine how to display it
      if (task.fileType === 'image') {
        fileDisplay = `<img src="${task.file}" alt="${task.fileName}" onclick="openModal('${task.file}', '${task.description}', 'image')">`;
      } else if (task.fileType === 'video') {
        fileDisplay = `<video src="${task.file}" controls style="max-width: 80px;" onclick="openModal('${task.file}', '${task.description}', 'video')"></video>`;
      } else if (task.fileName) {
        fileDisplay = `<a href="${task.file}" download="${task.fileName}" onclick="openModal('${task.file}', '${task.description}', 'file')">${task.fileName}</a>`;
      } else {
        fileDisplay = '';  // No file, so nothing to display
      }

      taskItem.innerHTML = `
        <div>
          <p><strong>${task.description}</strong></p>
          <p>Status: 
            <select onchange="updateTaskStatus(${task.id}, this.value)">
              <option value="Pending" ${task.status === 'Pending' ? 'selected' : ''}>Pending</option>
              <option value="WIP" ${task.status === 'WIP' ? 'selected' : ''}>WIP</option>
              <option value="Done" ${task.status === 'Done' ? 'selected' : ''}>Done</option>
            </select>
          </p>
        </div>
        ${fileDisplay}
      `;

      taskListElement.appendChild(taskItem);
    });
  }

  function updateTaskStatus(taskId, newStatus) {
    tasks = tasks.map(task => 
      task.id === taskId ? { ...task, status: newStatus } : task
    );
    updateLocalStorage();
    renderTasks(tasks);
  }

  function filterTasks() {
    const filterStatus = document.getElementById('filterStatus').value;

    if (filterStatus === 'All') {
      renderTasks(tasks);
    } else {
      const filteredTasks = tasks.filter(task => task.status === filterStatus);
      renderTasks(filteredTasks);
    }
  }

  function deleteAllTasks() {
    if (confirm('Are you sure you want to delete all tasks?')) {
      tasks = [];
      updateLocalStorage();
      renderTasks(tasks);
    }
  }

  function updateLocalStorage() {
    localStorage.setItem(userId + '_tasks', JSON.stringify(tasks));
  }

  // Modal Functions
  function openModal(fileSrc, description, fileType) {
    const modal = document.getElementById('fileModal');
    document.getElementById('modalDescription').innerText = description;

    // Handle display based on file type
    const modalImage = document.getElementById('modalImage');
    const modalVideo = document.getElementById('modalVideo');
    const modalLink = document.getElementById('modalLink');

    modalImage.style.display = 'none';
    modalVideo.style.display = 'none';
    modalLink.style.display = 'none';

    if (fileType === 'image') {
      modalImage.src = fileSrc;
      modalImage.style.display = 'block';
    } else if (fileType === 'video') {
      modalVideo.src = fileSrc;
      modalVideo.style.display = 'block';
    } else {
      modalLink.href = fileSrc;
      modalLink.textContent = 'Download File';
      modalLink.style.display = 'block';
    }

    modal.style.display = 'block';
  }

  function closeModal() {
    const modal = document.getElementById('fileModal');
    modal.style.display = 'none';
  }

  // Initial render on page load
  renderTasks(tasks);
</script>
